# TensorAlloy Manual

* Author: Xin Chen
* Email: Bismarrck@me.com
* Date: Dec 23, 2018
* **TensorAlloy** version: 1.0

## 1. Program

The `tensoralloy` program has two subcommands:

* `build`: build a _sqlite3_ database from a _xyz_ or _extxyz_ file.
* `run`: run an experiment from a TOML input file.

### 1.1 Subcommand: `build`

The `build` comamnd is used to build a 
[ase.db](https://wiki.fysik.dtu.dk/ase/ase/db/db.html#module-ase.db.core).

#### Usage

```bash
tensoralloy build filename [-h] 
                           [--num-examples NUM_EXAMPLES] 
                           [--energy-unit ENERGY_UNIT] 
                           [--forces-unit FORCES_UNIT] 
                           [--stress-unit STRESS_UNIT]
```

#### Args

* `filename`: a _xyz_ file or an _extxyz_ file. Please refer to 
    [ase.io.write](https://wiki.fysik.dtu.dk/ase/ase/io/io.html#module-ase.io) 
    for more information.
* `--num-examples`: the total number of examples to read. If not set, all 
    structures in the file will be read.
* `--energy-unit`: the unit of the total energies, possible options: 
    _eV_ (default), _Hartree_ or _kcal/mol_.
* `--forces-unit`: the unit of the atomic forces, possible options: 
    _eV/Angstrom_ (default), _eV/Bohr_, _Hartree/Angstrom_, _Hartree/Bohr_,
    _kcal/mol/Angstrom_ or _kcal/mol/Bohr_.
* `--stress-unit`: the unit of the stress tensors, possible options: 
    _GPa_ (default) or _kbar_.

#### Example

```bash
tensoralloy build datasets/qm7.xyz --energy-unit=Hartree
```

### 1.2 Subcommand: `run`

The subcommand `run` is used to run an experiment given a 
[TOML](https://github.com/toml-lang/toml) input file. Section 2 will introduce 
the input file. 

#### Usage

```bash
tensoralloy run input_file
```

#### Args

* `input_file`: a [TOML](https://github.com/toml-lang/toml) format input file to 
    read.

#### Example

```bash
export PYTHONPATH=`pwd`:$PYTHONPATH
cd test_files/inputs
tensoralloy run qm7.behler.k2.toml
```

## 2. Input

This section defines settings of the input 
[TOML](https://github.com/toml-lang/toml) file.

Below is the basic unit of TOML where _key_ represents an option of _section_ 
and _val_ is value of _key_.

```toml
[section]
key = val
```

There are two types of keys: _required_ and _optional_. If a key is marked 
_required_, its value must be provided by user in the input file. Optional keys 
can be ignored.

### 2.1 Section: `[dataset]`

* `sqlite3`: the [ase.db](https://wiki.fysik.dtu.dk/ase/ase/db/db.html) to use. 
    This database should be generated by command `tensoralloy build`.
    - type: string
    - required
* `name`: the name of this experiment.
    - type: string
    - required
    - **note: the character '-' is not allowed.**
* `descriptor`: the descriptor to describe this dataset. Available options are 
    _eam_ and _behler_.
    - type: string
    - required
* `rc`: the cutoff radius, in Angstroms.
    - type: float
    - default: 6.5
* `tfrecords_dir`: the directory to save/load generated tfrecords files.
    - type: string
    - default: "."
* `test_size`: the size of the evalutaion dataset. This can be an `int` 
    (absolute size, e.g. 1000) or a `float` (fraction size, e.g. 0.2).
    - type: int or float
    - default: 0.2

### 2.2 Section: `[nn]`

* `activation`: the activation function to use, _leaky\_relu_, _relu_, _elu_,     
    _tanh_ or _sigmoid_.
    - type: string
    - default: 'leaky_relu'
* `l2_weight`: the weight of the L2 regularization term. If zero, L2 
    regularization will be disabled. 
    - type: float
    - default: 0.0
* `minimize`: specify the structural properties to minimize. Should be a list of 
    string. Availabel properties are: _energy_, _forces_, _stress_ or 
    _total\_pressure_
    - type: List\[str\]
    - default: \['energy', 'forces'\]
* `predict`: specify the structural properties to predict. Should be a list of 
    string. Availabel properties are the same with `minimize`.
    - type: List\[str\]
    - default: \['energy', 'forces'\]

### 2.3 Section: `[nn.atomic]`

**Note**: This section should be configured if **dataset.descriptor** is 
**behler**.

This section defines the settings of the atomic neural network.

* `arch`: the architecture of the atomic neural network. Current implemented 
    archs are: _AtomicNN_ and _AtomicResNN_.
    - type: string
    - default: AtomicNN
* `input_normalizer`: specify the algorithm to normalize the symmetry function 
    descriptors. If _false_, normalization will be disabled. Availabel methods
    are _linear_ and _arctan_.
    - type: string or false
    - default: linear

### 2.4 Section: `[nn.atomic.layers]`

This section defines the layers of the atomistic neural network for each type of 
element. The keys are elements of the datasets and values should be lists of 
integers. 

Here is an example for Ni-Mo alloy:

```toml
[nn.atomic.layers]
Ni = [128, 64, 32]
Mo = [64, 32]
```

In this example, `Ni` will be described by an NN with **three** hidden layers 
and the correponding hidden layer sizes are 128, 64 and 32 while `Mo` will be 
described by an NN with **two** hidden layers of sizes 64 and 32.

`[64, 32]` is the default setting for all elements.

**Note**: This section should be configured if **dataset.descriptor** is 
**behler**.

### 2.5 Section `[behler]`

This section defines settings of Behler's symmetry function descriptor.

There are two types of symmetry functions:

1. Radial function G2:
   $$
   G^2_{i} = \sum_{j}{\vphantom{\sum}}'{
       \exp\left( -\frac{\eta}{R_{c}^2}r_{ij}^2 \right) f_{c}(r_{ij})
   }
   $$
2. Angular function G4:
   $$
   G^4_i = 2^{1 - \zeta}\sum_{j}{\vphantom{\sum}}'{
       \left( 1 + \gamma\cos{\theta_{ijk}} \right) \exp\left(
           -\frac{\beta}{R_c^2}(r_{ij}^2 + r_{ik}^2 + r_{jk}^2)
       \right) f_c(r_{ij}) f_c(r_{ik}) f_c(r_{jk})
   }
   $$

and $f_c(r)$ is the cosine cutoff function:

$$
f_c(r) = \left\{\begin{array}{cc}
\frac{1}{2}\left( \cos{(\frac{r}{R_c}\pi)} + 1 \right) & r \le R_c \\
0.0 & r \gt R_c
\end{array}
\right.
$$

* `eta`: the parameters $\eta$ for the radial function G2.
    - type: List[float]
    - default: [0.01, 0.4, 2.0, 10.0]
* `beta`: the parameters $\beta$ for the angular function G4.
    - type: List[float]
    - default: 
* `gamma`: the parameters $\gamma$ for the angular function G4.
    - type: List[float]
    - default: 
* `zeta`: the parameters $\zeta$ for the angular function G4.
    - type: List[float]
    - default: 

**Note**: This section should be configured if **dataset.descriptor** is 
**behler**.

### 2.6 Section: `[nn.eam]`

This section defines the settings of nn-EAM.

* `arch`: the architecture of the nn-EAM. Availabel archs are: _EamAlloyNN_ and
    _EamFsNN_. _EamAlloyNN_ represents the LAMMPS/eam/alloy potential and 
    _EamFsNN_ represents the LAMMPS/eam/fs (Finnis-Sinclair) potential.
    - type: string
    - default: `EamAlloyNN`

**Note**: This section should be configured if **dataset.descriptor** is 
**eam**.

### 2.7 Section: `[nn.eam.rho]`

This section defines the settings of the electron density functions of nn-EAM.

#### 2.7.1 `EamAlloyNN`

Style `eam/alloy` computes pairwise interactions for metals and metal alloys
using embedded-atom method (EAM) potentials 
([Baskes](https://link.aps.org/doi/10.1103/PhysRevB.29.6443)). The total energy 
$E_i$ of an atom $i$ is given by:

$$
E_i = F_\alpha\left(
    \sum_{j}{\vphantom{\sum}}'{\rho_{\beta}(r_{ij})} 
\right) + \frac{1}{2}\sum_{j}{\vphantom{\sum}}'{\phi_{\alpha\beta}}(r_{ij})
$$

where $F_{\alpha}$ is the embedding energy which is a function of the atomic 
electron density $\rho$, $\phi$ is a pair potential interaction, and $\alpha$ 
and $\beta$ are the element types of atoms $i$ and $j$. The multi-body nature of
the EAM potential is a result of the embedding energy term. Both summations in 
the formula are over all neighbors $j$ of atom $i$ within the cutoff distance.

Here is an example for AlCu alloy:

```toml
[nn.eam.rho]
Al = "zjw04"
Cu = [128, 64]
```

The electron density function of Al is 
[zjw04](https://doi.org/10.1103/PhysRevB.69.144113) while an NN with **two** 
layers is used to describe the electron density of Cu.

##### Available eam/alloy empirical potentials

* [zjw04](https://doi.org/10.1103/PhysRevB.69.144113): Al, Cu
* [sutton90](https://doi.org/10.1080/09500839008206493): Ag

#### 2.7.2 `EamFsNN`

Style `eam/fs` computes pairwise interactions for metals and metal alloys using 
a generalized form of EAM potentials due to Finnis and Sinclair 
([Finnis](https://doi.org/10.1080/01418618408244210)). The total energy $E_i$ of 
an atom $i$ is given by 

$$
E_i = F_\alpha\left(
    \sum_{j}{\vphantom{\sum}}'{\rho_{\alpha\beta}(r_{ij})} 
\right) + \frac{1}{2}\sum_{j}{\vphantom{\sum}}'{\phi_{\alpha\beta}}(r_{ij})
$$

where $\sum_{j}{\vphantom{\sum}}'$ means the summation goes over all possible 
$j$ except $j = i$. 

This has the same form as the EAM formula above, except that 
$\rho_{\alpha\beta}$ is now a functional specific to the atomic types of both 
atoms $i$ and $j$, so that different elements can contribute differently to the 
total electron density at an atomic site depending on the identity of the 
element at that atomic site.

Here is an example:

```toml
[nn.eam.rho]
AlAl = "msah11"
AlFe = [128, 64]
FeFe = "msah11"
FeAl = [128, 64]
```

The electron density of Al-Al and Fe-Fe are described by 
[msah11](https://doi.org/10.1557/JMR.2005.0024) while Al-Fe and Fe-Al are 
described by NNs. 

##### Available eam/alloy empirical potentials

* [msah11](https://doi.org/10.1557/JMR.2005.0024): Al, Fe

**Note**: This section should be configured if **dataset.descriptor** is 
**eam**.

### 2.8 Section: `[nn.eam.phi]`

This section defines the settings of the pairwise potential functions of nn-EAM.

Here is an example:

```toml
[nn.eam.phi]
AlAl = "zjw04"
CuCu = "zjw04"
AlCu = [128, 64]
```

The pairwise potentials of Al-Al and Cu-Cu are 
[zjw04](https://doi.org/10.1103/PhysRevB.69.144113) while Al-Cu is described by 
an NN.

**Note**: This section should be configured if **dataset.descriptor** is 
**eam**.

### 2.9 Section: `[nn.eam.embed]`

This section defines the settings of the embedding energy functions of nn-EAM.

```toml
[nn.eam.phi]
Al = "zjw04"
Cu = [128, 64]
```

The embedding function of Al is 
[zjw04](https://doi.org/10.1103/PhysRevB.69.144113) while Cu is described by an 
NN.

**Note**: This section should be configured if **dataset.descriptor** is 
**eam**.

### 2.10 Section: `[nn.eam.export]`

This section defines the settings for exporting a _setfl_ potential.

* `nr`: the number of `r` used to describe density and pair potentials.
    - type: int
    - default: 10000
* `dr`: the delta `r` used for tabulating density and pair potentials.
    - type: float
    - default: 0.00065
* `nrho`: the number of `rho` used to describe embedding functions.
    - type: int
    - default: 10000
* `drho`: the delta `rho` used for tabulating embedding functions.
    - type: float
    - default: 0.001

**Note**: This section should be configured if **dataset.descriptor** is 
**eam**.

### 2.11 Section: `[opt]`

This section defines the setting for SGD optimization. 

* `method`: the optimization method to use. Supported algorithms are: _adam_, 
    _rmsprop_, _adadelta_. See [tf.train] module for more information.
    - type: string
    - default: adam
* `learning_rate`: the initial learning rate.
    - type: float
    - default: 0.01
* `decay_function`: the learning rate decay function to use. If false, learning
    rate decay will be disabled. Supported decay functions are: _exponential_,
    _inverse\_time_ and _natural\_exp_. See [tf.train] module for more 
    information.
    - type: string or false
    - default: false
* `decay_rate`: the decay rate. See the computation detail of the decay 
    function. `0.0 < decay_rate < 1.0`.
    - type: float
    - default: 0.95
* `decay_steps`: the decay steps. See the computation detail of the decay 
    function. Must be positive.
    - type: int
    - default: 1000
* `staircase`: if true, decay the learning rate at discrete intervals.
    - type: string or false
    - default: false

### 2.12 Section: `[train]`

This section defines settings for training a model.

* `restart`: a boolean. If true, restart the previous training if possible. 
    Otherwise, files in `model_dir` will be deleted.
    - type: boolean
    - default: false
* `batch_size`: the size of one batch.
    - type: int
    - default: 50
* `shuffle`: a boolean indicating whether the dataset should be shuffled or not.
    In most cases this should be set to true.
    - type: boolean
    - default: false
* `model_dir`: directory where model parameters, graph, etc are saved.
    - type: string
    - required
* `max_checkpoints_to_keep`: the maximum number of recent checkpoint files to
    keep. As new files are created, older files are deleted. If zero, all 
    checkpoint files are kept.
    - type: int
    - default: 20
* `train_steps`: positive number of total steps for which to train model.
    - type: int
    - default: 10000
* `eval_steps`: positive number of steps for which to evaluate model.
    - type: int
    - default: 1000
* `summary_steps`: save summaries every this many steps.
    - type: int
    - default: 100
* `log_steps`: log key tensors and training progress every this many steps.
    - type: int
    - default: 100
* `profile_steps`: save profile traces every N steps.
    - type: int
    - default: 2000
